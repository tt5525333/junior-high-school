<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>國中班級經營 × 高效教學資源專區</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #F9FAFB; }
        .card { background-color: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); transition: transform 0.3s ease, box-shadow 0.3s ease; overflow: hidden; cursor: pointer; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1); }
        .keyword-tag { background-color: #FFFFFF; color: #004097; font-size: 0.75rem; padding: 3px 9px; border-radius: 6px; font-weight: 500; border: 1px solid #D1D5DB; cursor: pointer; transition: all 0.2s ease; }
        .keyword-tag:hover { background-color: #f0f9ff; border-color: #93c5fd; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        .content-fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .tab-button { padding: 8px 12px; border-bottom: 3px solid transparent; font-weight: 500; color: #6B7280; transition: all 0.2s ease; cursor: pointer; white-space: nowrap; }
        .tab-button:hover { color: #1C2271; border-bottom-color: #D1D5DB; }
        .tab-button.active { color: #1C2271; border-bottom-color: #1C2271; font-weight: 600; }
        .checklist-list { list-style-type: none; padding-left: 0; }
        .checklist-item { display: flex; align-items: center; padding: 10px 4px; border-bottom: 1px solid #F3F4F6; }
        .checklist-item:last-child { border-bottom: none; }
        .checklist-icon { flex-shrink: 0; width: 28px; height: 28px; margin-right: 12px; color: #004098; }
        
        /* Skeleton Loader */
        .skeleton-card { background-color: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); overflow: hidden; }
        .skeleton-img { background-color: #e5e7eb; aspect-ratio: 16/9; }
        .skeleton-text { background-color: #e5e7eb; height: 1.25rem; border-radius: 0.25rem; margin-bottom: 0.75rem; }
        .skeleton-text-sm { height: 0.875rem; }
        .skeleton-text-xs { height: 0.75rem; width: 50%; }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 50% { opacity: .5; } }

        /* Pagination */
        #pagination-container button { min-width: 40px; height: 40px; padding: 0 12px; border: 1px solid #D1D5DB; background-color: white; border-radius: 8px; font-weight: 500; color: #374151; transition: all 0.2s ease; }
        #pagination-container button:hover:not(:disabled) { background-color: #F3F4F6; border-color: #9CA3AF; }
        #pagination-container button.active { background-color: #1C2271; color: white; border-color: #1C2271; font-weight: 600; cursor: default; }
        #pagination-container button:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination-dots { display: flex; align-items: center; justify-content: center; min-width: 40px; height: 40px; color: #6B7280; }
        
        /* Hot Keywords */
        .hot-keyword-tag {
            background: none;
            border: none;
            padding: 0;
            color: #1C2271;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.2s ease, text-decoration 0.2s ease;
        }
        .hot-keyword-tag:hover { color: #004098; text-decoration: underline; }

        /* Mega Menu */
        .mega-menu-item {
            border-bottom: 4px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        .mega-menu-item.active, .mega-menu-item:hover {
            color: #1C2271;
            border-bottom-color: #1C2271;
        }
        .mega-menu-item.active svg {
            transform: rotate(180deg);
        }
        .mega-menu-pane {
            animation: slideDown 0.3s ease-in-out forwards;
            transform-origin: top;
            display: none; /* Initially hidden */
        }
        .mega-menu-pane.active {
            display: block; /* Show active pane */
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .mega-menu-tag {
            background-color: transparent;
            color: #374151;
            transition: color 0.2s ease, text-decoration 0.2s ease;
        }
        .mega-menu-tag:hover {
            color: #004098;
            text-decoration: underline;
        }
        /* Content Type Filter */
        .content-filter-button {
            padding-bottom: 8px;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            font-size: 1rem;
            color: #6B7280;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .content-filter-button:hover {
            color: #1C2271;
        }
        .content-filter-button.active {
            color: #1C2271;
            border-bottom-color: #1C2271;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header Section -->
    <header class="text-center pt-10 md:pt-12 pb-6 md:pb-8" style="background: linear-gradient(135deg, #E0F7FA 0%, #F5F5F5 50%, #E8EAF6 100%);">
        <div class="inline-block px-4 py-1.5 bg-[#1C2271] text-white text-sm font-semibold rounded-full mb-4">
            國中教師的工具箱
        </div>
        <h1 class="text-3xl md:text-5xl font-bold text-[#1C2271]">國中班級經營 × 高效教學資源專區</h1>
        <p class="mt-2 md:mt-4 text-lg md:text-xl text-gray-700">專為國中老師打造，有效解決教學現場大小事。</p>

        <!-- Controls Section -->
        <div class="mt-8 max-w-md mx-auto px-4">
            <div class="relative">
                <input type="text" id="search-input" placeholder="輸入關鍵字" class="w-full px-4 py-3 pr-12 border-gray-200 rounded-lg shadow-md focus:ring-2 focus:ring-[#004098] focus:border-[#004098] transition">
                <button id="search-button" class="absolute inset-y-0 right-0 flex items-center px-4 text-gray-500 hover:text-[#004098] transition-colors" aria-label="搜尋">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                    </svg>
                </button>
            </div>
            <div id="hot-keywords-container" class="mt-4 flex items-center justify-center gap-x-3 flex-nowrap px-2">
                <span class="text-sm font-medium text-gray-600 shrink-0">熱門關鍵字：</span>
                <button class="hot-keyword-tag">SEL</button>
                <button class="hot-keyword-tag">國中會考</button>
                <button class="hot-keyword-tag">班級經營</button>
                <button class="hot-keyword-tag">親師溝通</button>
            </div>
        </div>
    </header>

    <!-- Mega Menu Section -->
    <div id="mega-menu-container" class="sticky top-0 bg-white shadow-md z-40">
        <!-- Main menu items will be injected here -->
        <nav id="mega-menu-nav" class="container mx-auto flex justify-center border-b border-gray-200"></nav>
        <!-- Dropdown panes will be injected here -->
        <div id="mega-menu-panes-container" class="relative"></div>
    </div>


    <div class="container mx-auto px-4 py-8 md:py-12">
        <!-- Checklist Section -->
        <div id="checklist-section" class="mb-8 p-6 bg-white rounded-xl shadow-md" style="display: none;">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">學期行事曆重點任務</h3>
            <div class="border-b border-gray-200">
                <nav id="checklist-tabs" class="-mb-px flex space-x-2 md:space-x-6 overflow-x-auto" aria-label="Tabs">
                    <button data-tab="all" class="tab-button active">全部</button>
                    <button data-tab="start-school" class="tab-button">開學</button>
                    <button data-tab="mid-term" class="tab-button">期中</button>
                    <button data-tab="finals" class="tab-button">期末</button>
                    <button data-tab="vacation" class="tab-button">寒暑假</button>
                    <button data-tab="cap-exam" class="tab-button">國中會考</button>
                </nav>
            </div>
            <div id="checklist-content" class="mt-4 min-h-[150px]">
                <div id="checklist-loader" class="p-4 flex flex-col items-start justify-center w-full">
                    <p class="text-gray-600 mb-3">重點任務載入中...</p>
                    <div class="w-full max-w-xs bg-gray-200 rounded-full h-2.5">
                        <div id="checklist-progress-bar" class="bg-[#1C2271] h-2.5 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
                    </div>
                    <p id="checklist-progress-text" class="text-sm text-gray-500 mt-2">0%</p>
                </div>
            </div>
        </div>

        <!-- Content Type Filter -->
        <div id="content-type-filter" class="mb-8 border-b border-gray-200">
            <nav class="flex space-x-6" aria-label="篩選內容類型">
                <button data-type="all" class="content-filter-button active">全部內容</button>
                <button data-type="article" class="content-filter-button">文章</button>
                <button data-type="resource" class="content-filter-button">資源</button>
            </nav>
        </div>
        
        <!-- No Results Message -->
        <div id="no-results" class="hidden text-center py-16">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
            </svg>
            <h3 class="mt-2 text-sm font-semibold text-gray-900">找不到結果</h3>
            <p class="mt-1 text-sm text-gray-500">請嘗試使用不同的關鍵字或篩選條件。</p>
        </div>
        
        <!-- Articles Grid -->
        <main id="card-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Skeletons or Cards will be rendered here -->
        </main>

        <!-- Pagination -->
        <div id="pagination-container" class="flex justify-center items-center flex-wrap gap-2 mt-12"></div>

    </div>

<script>
    const cardContainer = document.getElementById('card-container');
    const searchInput = document.getElementById('search-input');
    const searchButton = document.getElementById('search-button');
    const noResultsDiv = document.getElementById('no-results');
    const checklistTabs = document.getElementById('checklist-tabs');
    const checklistContent = document.getElementById('checklist-content');
    const paginationContainer = document.getElementById('pagination-container');
    const hotKeywordsContainer = document.getElementById('hot-keywords-container');
    const megaMenuNav = document.getElementById('mega-menu-nav');
    const megaMenuPanesContainer = document.getElementById('mega-menu-panes-container');
    const contentTypeFilter = document.getElementById('content-type-filter');


    const GOOGLE_SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbwEt2gRcaihTRVMzntDpwpM0yyfAJAYCgQmimbX9mGhZfFZr6NLO9qdEiVTVDTLeRLttw/exec';

    let allArticleData = [];
    let allChecklistData = {};
    let currentPage = 1;
    let activeContentType = 'all'; // 'all', 'article', 'resource'
    const articlesPerPage = 12;

    const semesterTagToTabId = {
        '開學': 'start-school',
        '期中': 'mid-term',
        '期末': 'finals',
        '寒暑假': 'vacation',
        '國中會考': 'cap-exam'
    };
    const semesterTags = Object.keys(semesterTagToTabId);

    const menuData = [
        {
            title: '教育實務',
            tags: ['班級經營', '親師溝通', '輔導管教', '校園法規', '學校行政', '台灣現場', '教育趨勢']
        },
        {
            title: '科目',
            tags: ['國文領域', '英文領域', '數學領域', '社會領域', '自然領域']
        },
        {
            title: '教學',
            tags: ['教學設計', '數位／資訊融入教學', 'SEL情緒', 'SDGs', 'PBL', '閱讀理解', '雙語教育', '節慶主題']
        },
        {
            title: '學習',
            tags: ['學習策略', '思考方法', '寫作技巧', '生涯探索', '公民素養']
        },
        {
            title: '學期行事曆',
            tags: ['開學', '期中', '期末', '寒暑假', '國中會考']
        }
    ];

    /**
     * Renders the mega menu navigation and its dropdown panes.
     */
    function renderMegaMenu() {
        menuData.forEach((item, index) => {
            // Create nav item
            const navItem = document.createElement('button');
            navItem.className = 'mega-menu-item flex items-center gap-x-1 px-4 py-3 text-base font-semibold text-gray-600';
            navItem.dataset.index = index;
            navItem.innerHTML = `
                <span>${item.title}</span>
                <svg class="w-4 h-4 transition-transform duration-200" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            `;
            megaMenuNav.appendChild(navItem);

            // Create pane
            const pane = document.createElement('div');
            pane.className = 'mega-menu-pane absolute top-full left-0 w-full bg-white shadow-lg p-8';
            pane.dataset.index = index;

            const tagGrid = document.createElement('div');
            tagGrid.className = 'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 container mx-auto';
            
            item.tags.forEach(tag => {
                const tagButton = document.createElement('button');
                tagButton.className = 'mega-menu-tag w-full text-left p-3 rounded-lg text-sm';
                tagButton.textContent = tag;
                tagGrid.appendChild(tagButton);
            });

            pane.appendChild(tagGrid);
            megaMenuPanesContainer.appendChild(pane);
        });
    }


    /**
     * Renders skeleton placeholders while data is loading.
     * @param {number} count - The number of skeletons to render.
     */
    function renderSkeletons(count) {
        cardContainer.innerHTML = '';
        noResultsDiv.style.display = 'none';
        for (let i = 0; i < count; i++) {
            const skeleton = document.createElement('div');
            skeleton.className = 'skeleton-card';
            skeleton.innerHTML = `
                <div class="skeleton-img animate-pulse"></div>
                <div class="p-6">
                    <div class="skeleton-text animate-pulse w-3/4"></div>
                    <div class="skeleton-text animate-pulse skeleton-text-sm"></div>
                    <div class="skeleton-text animate-pulse skeleton-text-sm w-5/6"></div>
                    <div class="pt-4 mt-auto">
                       <div class="mt-8 flex justify-between">
                            <div class="skeleton-text animate-pulse skeleton-text-xs"></div>
                            <div class="skeleton-text animate-pulse skeleton-text-xs"></div>
                        </div>
                    </div>
                </div>
            `;
            cardContainer.appendChild(skeleton);
        }
    }

    /**
     * Renders the article cards to the page.
     * @param {Array} articles - An array of article objects to render.
     */
    function renderCards(articles) {
        cardContainer.innerHTML = '';
        noResultsDiv.style.display = articles.length === 0 ? 'block' : 'none';

        articles.forEach(article => {
            const keywordsHtml = (article.keywords || []).map(kw => `<button data-keyword="${kw}" class="keyword-tag">${kw}</button>`).join(' ');

            let imageBlock = '';
            if (article.imageUrl) {
                const ratio = (article.imageRatio === '1:1') ? '1/1' : '16/9';
                imageBlock = `<div class="w-full aspect-[${ratio}] bg-gray-100 overflow-hidden"><img src="${article.imageUrl}" alt="${article.title}" class="w-full h-full object-cover" onerror="this.parentElement.style.display='none'"></div>`;
            }

            let buttonText = '閱讀全文';
            if (article.buttonType === 'download') {
                buttonText = '下載資源';
            } else if (article.buttonType === 'special_section') {
                buttonText = '前往專區';
            } else if (article.buttonType === 'video') {
                buttonText = '回看影音';
            }

            const card = document.createElement('div');
            card.className = 'card fade-in flex flex-col';
            card.innerHTML = imageBlock + `<div class="p-6 flex flex-col flex-grow"><div class="flex-grow"><h2 class="text-xl font-bold mb-2 text-gray-900">${article.title}</h2><p class="text-gray-600 mb-4 text-sm leading-relaxed">${article.summary}</p></div><div class="pt-4 mt-auto"><div class="flex flex-wrap gap-2 mb-4">${keywordsHtml}</div><div class="flex justify-between items-center text-xs text-gray-500"><span>作者：${article.author}</span><span>發布於：${article.publishDate}</span></div><div class="text-right mt-4"><a href="${article.url}" target="_blank" rel="noopener noreferrer" class="inline-block px-4 py-2 bg-[#1C2271] text-white rounded-lg hover:bg-[#004098] transition duration-300 font-semibold">${buttonText}</a></div></div></div>`;

            card.addEventListener('click', (e) => {
                if (e.target.closest('a') || e.target.closest('button.keyword-tag')) return;
                window.open(article.url, '_blank', 'noopener,noreferrer');
            });

            cardContainer.appendChild(card);
        });
    }

    /**
     * Renders the pagination controls.
     * @param {number} totalItems - The total number of items to paginate.
     */
    function renderPagination(totalItems) {
        paginationContainer.innerHTML = '';
        const totalPages = Math.ceil(totalItems / articlesPerPage);
        if (totalPages <= 1) return;

        const createButton = (page, text = page, isDisabled = false) => {
            const button = document.createElement('button');
            button.dataset.page = page;
            button.textContent = text;
            if (page === currentPage) button.className = 'active';
            if (isDisabled) button.disabled = true;
            return button;
        };

        const createDots = () => {
            const span = document.createElement('span');
            span.className = 'pagination-dots';
            span.textContent = '...';
            return span;
        };
        
        paginationContainer.appendChild(createButton(currentPage - 1, '‹', currentPage === 1));

        const pagesToShow = new Set();
        pagesToShow.add(1);
        if (totalPages > 1) pagesToShow.add(2);
        if (totalPages > 2) pagesToShow.add(totalPages - 1);
        if (totalPages > 3) pagesToShow.add(totalPages);
        pagesToShow.add(currentPage);
        if (currentPage > 1) pagesToShow.add(currentPage - 1);
        if (currentPage < totalPages) pagesToShow.add(currentPage + 1);

        let lastPage = 0;
        Array.from(pagesToShow).sort((a, b) => a - b).forEach(page => {
            if (page > 0 && page <= totalPages) {
                if (page > lastPage + 1) paginationContainer.appendChild(createDots());
                paginationContainer.appendChild(createButton(page));
                lastPage = page;
            }
        });
        
        paginationContainer.appendChild(createButton(currentPage + 1, '›', currentPage === totalPages));
    }

    /**
     * Renders the checklist items for a given tab.
     * @param {string} tabId - The ID of the checklist tab to display.
     */
    function renderChecklist(tabId) {
        const items = allChecklistData[tabId] || [];
        let contentHtml;
        if (items.length === 0) {
            contentHtml = `<p class="text-gray-500 p-4">此區間尚無重點任務。</p>`;
        } else {
            const itemList = items.map(item => `<li class="checklist-item"><svg class="checklist-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg><span class="text-gray-700">${item.event}</span></li>`).join('');
            contentHtml = `<ul class="checklist-list">${itemList}</ul>`;
        }
        checklistContent.innerHTML = `<div class="content-fade-in">${contentHtml}</div>`;
    }

    /**
     * Filters and sorts the articles based on the current UI controls.
     * @returns {Array} The filtered and sorted array of articles.
     */
    function filterAndSortArticles() {
        const activeTab = checklistTabs.querySelector('.active');
        const activePeriod = activeTab ? activeTab.dataset.tab : 'all';
        const searchTerm = searchInput.value.toLowerCase().trim();

        let filteredArticles = allArticleData;

        // 1. Filter by content type
        if (activeContentType === 'article') {
            // Articles are anything that isn't a 'download' type resource
            filteredArticles = filteredArticles.filter(article => article.buttonType !== 'download');
        } else if (activeContentType === 'resource') {
            filteredArticles = filteredArticles.filter(article => article.buttonType === 'download');
        }

        if (activePeriod !== 'all') {
            filteredArticles = filteredArticles.filter(article => (article.period || '').toLowerCase() === activePeriod);
        }

        if (searchTerm) {
            filteredArticles = filteredArticles.filter(article => 
                (article.title || '').toLowerCase().includes(searchTerm) ||
                (article.summary || '').toLowerCase().includes(searchTerm) ||
                (article.author || '').toLowerCase().includes(searchTerm) ||
                (article.keywords || []).some(kw => kw.toLowerCase().includes(searchTerm)) ||
                (article.fullText || '').toLowerCase().includes(searchTerm)
            );
        }

        filteredArticles.sort((a, b) => {
            if (activePeriod === 'cap-exam') {
                const aIsSpecial = a.buttonType === 'special_section';
                const bIsSpecial = b.buttonType === 'special_section';
                if (aIsSpecial !== bIsSpecial) return bIsSpecial - aIsSpecial;
            }

            if (searchTerm) {
                const aIsDownload = a.buttonType === 'download';
                const bIsDownload = b.buttonType === 'download';
                if (aIsDownload !== bIsDownload) return bIsDownload - aIsDownload;
                
                const getScore = (article) => {
                    if ((article.title || '').toLowerCase().includes(searchTerm)) return 4;
                    if ((article.summary || '').toLowerCase().includes(searchTerm)) return 3;
                    if ((article.keywords || []).some(kw => kw.toLowerCase().includes(searchTerm))) return 2;
                    if ((article.fullText || '').toLowerCase().includes(searchTerm)) return 1;
                    return 0;
                };
                const scoreA = getScore(a);
                const scoreB = getScore(b);
                if (scoreA !== scoreB) return scoreB - scoreA;
            }
            
            const today = new Date();
            const oneDay = 1000 * 60 * 60 * 24;
            
            const getDayOfYear = (dateStr) => {
                const date = new Date(dateStr);
                date.setFullYear(2001);
                const startOfFixedYear = new Date(2001, 0, 0);
                return Math.floor((date - startOfFixedYear) / oneDay);
            };

            const todayDayOfYear = getDayOfYear(today.toISOString());
            const dayA = getDayOfYear(a.publishDate);
            const dayB = getDayOfYear(b.publishDate);
            const distA = Math.abs(dayA - todayDayOfYear);
            const distB = Math.abs(dayB - todayDayOfYear);
            const proximityA = Math.min(distA, 365 - distA);
            const proximityB = Math.min(distB, 365 - distB);

            if (proximityA !== proximityB) {
                return proximityA - proximityB;
            }

            const yearA = new Date(a.publishDate).getFullYear();
            const yearB = new Date(b.publishDate).getFullYear();
            return yearB - yearA;
        });
        
        return filteredArticles;
    }
    
    /**
     * Filters articles, then renders the current page of cards and pagination.
     */
    function updateDisplay() {
        const filteredArticles = filterAndSortArticles();
        const totalItems = filteredArticles.length;
        const startIndex = (currentPage - 1) * articlesPerPage;
        const endIndex = startIndex + articlesPerPage;
        const paginatedArticles = filteredArticles.slice(startIndex, endIndex);
        renderCards(paginatedArticles);
        renderPagination(totalItems);
    }

    /**
     * Triggers a search and resets to the first page.
     */
    function performSearch(options = {}) {
        const { isFromSemesterSource = false } = options;
        const checklistSection = document.getElementById('checklist-section');
        const searchTerm = searchInput.value.trim();

        const isSemesterKeyword = semesterTags.includes(searchTerm);

        if (isFromSemesterSource || isSemesterKeyword) {
            checklistSection.style.display = 'block';
            
            // Sync the checklist's active tab to match the search term
            if (isSemesterKeyword) {
                const tabId = semesterTagToTabId[searchTerm];
                const activeTab = checklistTabs.querySelector('.active');
                const targetTab = checklistTabs.querySelector(`[data-tab="${tabId}"]`);
                if (targetTab && (!activeTab || activeTab.dataset.tab !== tabId)) {
                    if(activeTab) activeTab.classList.remove('active');
                    targetTab.classList.add('active');
                    renderChecklist(tabId);
                }
            }
        } else {
            checklistSection.style.display = 'none';
        }

        currentPage = 1;
        updateDisplay();
    }
    
    function closeAllMegaMenuPanes() {
        document.querySelectorAll('.mega-menu-pane.active').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.mega-menu-item.active').forEach(i => i.classList.remove('active'));
    }

    // Main application logic starts here
    document.addEventListener('DOMContentLoaded', () => {
        renderSkeletons(12);
        renderMegaMenu();

        const checklistProgressBar = document.getElementById('checklist-progress-bar');
        const checklistProgressText = document.getElementById('checklist-progress-text');
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += Math.floor(Math.random() * 5) + 1;
            if (progress >= 95) {
                progress = 95;
                clearInterval(progressInterval);
            }
            if(checklistProgressBar) checklistProgressBar.style.width = progress + '%';
            if(checklistProgressText) checklistProgressText.textContent = progress + '%';
        }, 120);

        fetch(GOOGLE_SHEET_API_URL)
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok: ' + response.status);
                return response.json();
            })
            .then(data => {
                clearInterval(progressInterval);
                if(checklistProgressBar) checklistProgressBar.style.width = '100%';
                if(checklistProgressText) checklistProgressText.textContent = '100%';

                setTimeout(() => {
                    allArticleData = data.articles || [];
                    allChecklistData = data.checklists || {};
                    
                    renderChecklist('all'); 
                    currentPage = 1;
                    updateDisplay(); 

                    // --- Event Listeners ---
                    checklistTabs.addEventListener('click', (e) => {
                        if (e.target.matches('.tab-button')) {
                            checklistTabs.querySelector('.active').classList.remove('active');
                            e.target.classList.add('active');
                            renderChecklist(e.target.dataset.tab);
                            performSearch({ isFromSemesterSource: true });
                        }
                    });
                    
                    searchButton.addEventListener('click', performSearch);
                    searchInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            performSearch();
                        }
                    });

                    contentTypeFilter.addEventListener('click', (e) => {
                        if (e.target.matches('.content-filter-button')) {
                            contentTypeFilter.querySelector('.active').classList.remove('active');
                            e.target.classList.add('active');
                            activeContentType = e.target.dataset.type;
                            currentPage = 1; // Reset page on filter change
                            updateDisplay();
                        }
                    });

                    paginationContainer.addEventListener('click', (e) => {
                        const target = e.target.closest('button');
                        if (!target || target.disabled || target.classList.contains('active')) return;

                        const page = parseInt(target.dataset.page, 10);
                        currentPage = page;
                        updateDisplay();
                        cardContainer.scrollIntoView({ behavior: 'smooth' });
                    });

                    cardContainer.addEventListener('click', (e) => {
                        const keywordTag = e.target.closest('button.keyword-tag');
                        if (!keywordTag) return;
                        const keyword = keywordTag.dataset.keyword;
                        if (keyword) {
                            searchInput.value = keyword;
                            performSearch();
                            document.querySelector('header').scrollIntoView({ behavior: 'smooth' });
                        }
                    });

                    if (hotKeywordsContainer) {
                        hotKeywordsContainer.addEventListener('click', (e) => {
                            if (e.target.matches('.hot-keyword-tag')) {
                                const keyword = e.target.textContent.trim();
                                searchInput.value = keyword;
                                performSearch();
                            }
                        });
                    }

                    // Mega Menu Listeners
                    megaMenuNav.addEventListener('click', (e) => {
                        const navItem = e.target.closest('.mega-menu-item');
                        if (!navItem) return;

                        const index = navItem.dataset.index;
                        const targetPane = document.querySelector(`.mega-menu-pane[data-index='${index}']`);
                        const isAlreadyActive = navItem.classList.contains('active');

                        closeAllMegaMenuPanes();

                        if (!isAlreadyActive) {
                            navItem.classList.add('active');
                            if (targetPane) targetPane.classList.add('active');
                        }
                    });

                    megaMenuPanesContainer.addEventListener('click', (e) => {
                        const tagButton = e.target.closest('.mega-menu-tag');
                        if (tagButton) {
                            searchInput.value = tagButton.textContent.trim();
                            performSearch();
                            closeAllMegaMenuPanes();
                        }
                    });
                    
                    document.addEventListener('click', (e) => {
                        if (!document.getElementById('mega-menu-container').contains(e.target)) {
                            closeAllMegaMenuPanes();
                        }
                    });

                }, 400); 
            })
            .catch(error => {
                clearInterval(progressInterval);
                console.error('Error fetching data:', error);
                cardContainer.innerHTML = `<p class="text-center col-span-full text-red-600">資料載入失敗，請檢查網路連線或聯繫管理員。</p>`;
                checklistContent.innerHTML = `<p class="text-center text-red-600">任務載入失敗。</p>`
            });
    });
</script>
</body>
</html>

